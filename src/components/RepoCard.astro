---
import type { GitHubRepo } from '../lib/github.js'
import { Icon } from 'astro-icon/components'
import { format } from 'date-fns'

interface Props {
  repo: GitHubRepo
}

const { repo } = Astro.props

// Format the last updated date (relative)
const formatRelativeDate = (dateString: string): string => {
  const date = new Date(dateString)
  const now = new Date()
  const diffInDays = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24))

  if (diffInDays === 0) return 'today'
  if (diffInDays === 1) return 'yesterday'
  if (diffInDays < 7) return `${diffInDays} days ago`
  if (diffInDays < 30) return `${Math.floor(diffInDays / 7)} weeks ago`
  if (diffInDays < 365) return `${Math.floor(diffInDays / 30)} months ago`
  return `${Math.floor(diffInDays / 365)} years ago`
}

// Format abbreviated date
const formatAbbreviatedDate = (dateString: string): string => {
  return format(new Date(dateString), 'MMM d, yyyy')
}

const relativeDate = formatRelativeDate(repo.pushedAt)
const abbreviatedDate = formatAbbreviatedDate(repo.pushedAt)

// Extract topics from repository topics
const topics = repo.repositoryTopics.nodes.map((node) => node.topic.name)
---

<div
  class="flex flex-col h-full border border-gray-200 dark:border-gray-800 rounded p-6 hover:border-gray-300 dark:hover:border-gray-700 transition-colors"
>
  <!-- Header with name and stats -->
  <div class="flex items-center justify-between mb-2">
    <h3 class="text-xl font-semibold">
      <a
        href={repo.url}
        target="_blank"
        rel="noopener noreferrer"
        class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
      >
        {repo.name}
      </a>
    </h3>
    <div class="flex items-center gap-3 text-sm text-gray-500 dark:text-gray-400 flex-shrink-0 ml-4">
      <div class="flex items-center gap-1" title="Stars">
        <Icon name="lucide:star" class="w-4 h-4" />
        <span>{repo.stargazerCount}</span>
      </div>
      <div class="flex items-center gap-1" title="Forks">
        <Icon name="lucide:git-branch" class="w-4 h-4" />
        <span>{repo.forkCount}</span>
      </div>
    </div>
  </div>

  <!-- Description -->
  <p class="text-sm text-gray-600 dark:text-gray-400 mb-3 flex-grow">
    {repo.description || 'No description available'}
  </p>

  <!-- Tags -->
  {
    topics.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-3">
        {topics.map((topic) => (
          <a
            href={`https://github.com/topics/${topic}`}
            target="_blank"
            rel="noopener noreferrer"
            class="px-2 py-1 text-xs rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
          >
            {topic}
          </a>
        ))}
      </div>
    )
  }

  <!-- Compact data list -->
  <dl class="space-y-1 text-xs text-gray-500 dark:text-gray-400">
    {
      repo.primaryLanguage && (
        <div class="flex items-center">
          <dt class="opacity-60 flex-shrink-0">Language</dt>
          <div class="flex-grow mx-2 border-b border-dotted border-gray-300 dark:border-gray-700 opacity-30" />
          <dd class="flex-shrink-0 truncate text-right">
            <a
              href={`https://github.com/jasonkuhrt?tab=repositories&language=${encodeURIComponent(repo.primaryLanguage.name.toLowerCase())}`}
              target="_blank"
              rel="noopener noreferrer"
              class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
            >
              {repo.primaryLanguage.name}
            </a>
          </dd>
        </div>
      )
    }
    {
      repo.latestRelease && (
        <div class="flex items-center">
          <dt class="opacity-60 flex-shrink-0">Latest release</dt>
          <div class="flex-grow mx-2 border-b border-dotted border-gray-300 dark:border-gray-700 opacity-30" />
          <dd class="flex-shrink-0 truncate text-right">
            <a
              href={repo.latestRelease.url}
              target="_blank"
              rel="noopener noreferrer"
              class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
            >
              {repo.latestRelease.tagName}
            </a>
          </dd>
        </div>
      )
    }
    {
      repo.defaultBranchRef && (
        <div class="flex items-center">
          <dt class="opacity-60 flex-shrink-0">Last commit</dt>
          <div class="flex-grow mx-2 border-b border-dotted border-gray-300 dark:border-gray-700 opacity-30" />
          <dd class="flex-shrink-0 truncate text-right">
            <a
              href={repo.defaultBranchRef.target.commitUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
              title={abbreviatedDate}
            >
              {relativeDate}
            </a>
          </dd>
        </div>
      )
    }
  </dl>
</div>
